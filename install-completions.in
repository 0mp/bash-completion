#!/bin/bash
# install relevant completions, by sourcing every scriptlet
# found in a given directory, and symlinking those matching
# an installed command to another directory

have()
{
    PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin type $1 &>/dev/null
}

usage()
{
    echo "usage: $0 [completion]"
}

link()
{
    # reset completion
    complete -r

    # source script
    source $1 2>/dev/null

    # check completion output
    output=$(complete -p)

    if [ -z "$output" ]; then
	    return;
    fi
    ln -sf $1 @compatdir@/$(basename $1)
}

while getopts ":h" flag; do
    case $flag in
	h) usage; exit 0;;
    esac
done

shift $((OPTIND - 1))

completion=$1

# many scripts require this
shopt -s extglob

# and some require this also
UNAME=$(uname -s)
UNAME=${UNAME/CYGWIN_*/Cygwin}

case $UNAME in
    Linux|GNU|GNU/*) USERLAND=GNU ;;
    *) USERLAND=$UNAME ;;
esac

if [ -z "$completion" ]; then
    for script in @contribdir@/*; do
        link $script
    done
fi
